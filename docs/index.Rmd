---
title: "Assessment"
author: "Naveed"
date: "2024-11-01"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE, message=FALSE, warning=FALSE)
```

## Research Question

How does the prescription of diabetes medications (specifically metformin, insulin, sulphonylureases, GLP-1 antagonists and SGLT2 inhibitors) vary across socioeconomically diverse regions in Scotland and what relationship does it have with cardiovascular and stroke mortality in 2022?

## Introduction
Diabetes plays an important role in cardiovascular health with it being a major risk factor for a variety of cardiovascular diseases (NHS, 2022). Diabetes drug prescriptions can be influenced by a variety of factors such as deprivation. 

## The Libraries

This section contains the code for loading in all the required libraries. 

```{r}
library(tidyverse)
library(here)
library(janitor)
library(gt)
library(sf)
library(ggspatial)
```

## The Data

This section contains the code for loading in all the required datasets. 

```{r, results = "hide"}
files <- list.files(here("data", "year_data"), pattern = "csv", full.names = TRUE)

year_data <- files %>%
  map_dfr(~read_csv(., col_types = cols(
    DMDCode = col_character()
  ))) %>%
  clean_names() %>% 
  rename(hb = hbt)
#Loads in the data for prescriptions across 2022

hb_data <- read_csv("https://www.opendata.nhs.scot/dataset/9f942fdb-e59e-44f5-b534-d6e17229cc7b/resource/652ff726-e676-4a20-abda-435b98dd7bdc/download/hb14_hb19.csv") %>% 
  clean_names() %>% 
  select(hb, hb_name)
#Loads in the data for healthboard names

special_hb_data <- read_csv("https://www.opendata.nhs.scot/dataset/65402d20-f0f1-4cee-a4f9-a960ca560444/resource/0450a5a2-f600-4569-a9ae-5d6317141899/download/special-health-boards_19022021.csv") %>% 
  clean_names() %>% 
  rename(hb_name = shb_name,
         hb = shb) %>% 
  select(-country)
#Loads in data for special healthboards
hb_data <- full_join(hb_data, special_hb_data)

deprivation_data <- read_csv("https://www.opendata.nhs.scot/dataset/78d41fa9-1a62-4f7b-9edb-3e8522a93378/resource/acade396-8430-4b34-895a-b3e757fa346e/download/simd2020v2_22062020.csv") %>% 
  select(DataZone:CA, SIMD2020V2CountryDecile, -HB, -CA)%>% #, -HB, -CA
  clean_names()

#mortality_deprivation_data <- deprivation_data
#group_by(hb_name) %>% 
#summarize()

#Loads in the average deprivation index for each health board

population_data <- read_csv(here( "data", "UV103_age_health_board_census.csv"), skip = 10) %>% 
  rename(Spare = "...6",
         hb_name = "Health Board Area 2019",
         hb_population = Count) %>% 
  filter(Age == "All people" & Sex == "All people") %>% 
  select(hb_name, hb_population) %>% 
  mutate(hb_name = paste("NHS", hb_name)) %>% 
    clean_names()
#Loads in the population data per health board
  
  NHS_healthboards <- st_read(here("data", "NHS_healthboards_2019.shp")) %>% 
    clean_names()
#Loads in the data for the creation of the map
  
geography_data <- read_csv("https://www.opendata.nhs.scot/dataset/9f942fdb-e59e-44f5-b534-d6e17229cc7b/resource/395476ab-0720-4740-be07-ff4467141352/download/dz2011_codes_and_labels_21042020.csv") %>% 
  select(DataZone, DataZoneName, CA) %>% 
  clean_names()
#Loads in the names for the datazone

gp_data <- read_csv("https://www.opendata.nhs.scot/dataset/f23655c3-6e23-4103-a511-a80d998adb90/resource/64b42f68-3353-449b-bc1c-0f733b21803b/download/practice_contactdetails_oct2024-open-data.csv") %>% 
  clean_names() %>% 
#Loads in the data for each GP and includes the population as well
  select(practice_code, data_zone)

#%>%
#  summarise(across(c(DataZone, all_ages), ~head(., 1)))
#Prevents the creation of multiple observations

gp_data <- left_join(gp_data, geography_data, by = join_by(data_zone == data_zone)) 
  
stroke_mortality_data <- read_csv("https://www.opendata.nhs.scot/dataset/f5dcf382-e6ca-49f6-b807-4f9cc29555bc/resource/285b4cbd-1e87-49fe-9e24-73d2da8166ae/download/stroke_mortalitybyca.csv") %>% 
  clean_names() %>% 
  filter(year == 2022) %>% 
  group_by(ca) %>% 
  summarise(number_of_deaths = sum(number_of_deaths, na.rm = TRUE))
```

##Joining The Datasets

This section of code joins the various datasets of interest to create the joined data.
It then filters based on the relevant requirements.
First we filter out 

```{r}
weightdrug_data <- left_join(year_data, gp_data, by = join_by(gp_practice == practice_code)) %>% 
  #Joins the health board names with the prescriptions dataset
  filter(str_detect(bnf_item_description, "METFORMIN|INSULIN|GLUTIDE|OZEMPIC|SAXENDA|TRULICITY|GLICLAZIDE|GLIPIZIDE|GLIFLOZIN"),
         is.na(data_zone) != TRUE) %>%   #Filters for the GLP-1 antagonists and summarizes paid quantity
  left_join(., hb_data, by = join_by(hb == hb)) %>% 
  left_join(., deprivation_data, by = join_by(data_zone == data_zone)) %>% 
  #Adds in deprivation index for each health board
  left_join(., population_data) %>% 
  left_join(., stroke_mortality_data)

map_data <- weightdrug_data %>% 
  group_by(hb) %>% 
  summarise(paid_quantity = sum(paid_quantity)) %>% 
  left_join(., NHS_healthboards, by = join_by(hb == hb_code)) 
#Adds in deprivation index for each health board

dp_plot_data <- weightdrug_data %>%
  group_by(data_zone, gp_practice, hb, hb_name) %>% 
  summarise(paid_quantity = sum(paid_quantity),
            simd = unique(simd2020v2country_decile))
  #Joins in population data and geography data for the map

### THE ONLY PART THAT NEEDS CHANGING IN THIS SECTION
### REMEMBER TO EDIT THE SIMD AS YOU DO NOT NEED TO GROUP BY DATA ZONE
str_mortality_plot_data <- weightdrug_data %>% 
  left_join(., population_data) %>%
  group_by(hb, hb_name, ca) %>% # add bnf_item_description
  summarise(paid_quantity = sum(paid_quantity),
            average_simd_per_hb = mean(simd2020v2country_decile),
            mortality = unique(number_of_deaths))

missing_data <- dp_plot_data %>% 
  filter(across(everything(), ~is.na(.)))

#FIX MISSING DATA PROBLEM
```

##Map for distribution of prescriptions across Scotland
This map show the distribution of these prescriptions around Scotland.

```{r}
map_data %>%
ggplot(aes(geometry = geometry, fill = paid_quantity)) +
  geom_sf() +
  scale_fill_distiller(palette = "RdYlBu") +
  labs(title = "Number of Diabetes Drug Prescriptions", subtitle = "In Scotland", fill = "Total No. of Prescriptions") +  
  annotation_scale(location = "tl") +
  annotation_north_arrow(
    location = "tl",    
    pad_y = unit(0.5, "in"),    
    style = north_arrow_nautical(
      fill = c("blue", "white"),      
      line_col = "grey20"
    ) 
  )+
  # Add health board names as labels
  geom_sf_text(aes(label = hb_name), size = 2, color = "black", fontface = "bold")  # Adjust size and color of the text

# limits = c(0, 10000000), oob = scales::squish
```

##Graph for prescriptions vs SIMD

```{r}
#plot_data %>% 
#ggplot(aes(x = average_simd, y = paid_quantity)) +
#  geom_point() +
#  geom_smooth(method = "lm") +
#  theme(axis.text.x = element_text( 
#   angle = 90,
#   size=7, 
#   face=3)) +
#  labs(title = "Prescriptions vs SIMD", y = "Prescriptions", x = "SIMD")

dp_plot_data %>% 
  ggplot(aes(x = simd, y = paid_quantity, color = hb_name)) +  # Map color to health board
  geom_point(angle = 90,
    face=3,
    size = 2,        # Size of points
    alpha = 0.7      # Transparency of points
  ) +
  geom_smooth(method = "lm", color = "red", size = 1) +  # Add regression line with a different color
  theme_bw() +  # Minimal theme for a cleaner look
  theme(
    axis.text.x = element_text(
      size = 10,   # Adjust size of x-axis text
      hjust = 1     # Horizontal alignment of x-axis text
    ),
    axis.text.y = element_text(size = 10),  # Adjust size of y-axis text
    axis.title = element_text(size = 12),   # Increase axis title font size
    plot.title = element_text(size = 14, face = "bold"),  # Increase title size and make it bold
    plot.subtitle = element_text(size = 10),  # Subtitle size
    panel.grid.major = element_line(color = "grey90", size = 0.5),  # Lighter grid lines
  ) +
  labs(
    title = "Prescriptions of Diabetes Drugs vs average SIMD",
    subtitle = "Relationship between the average SIMD decile and the number of prescriptions of diabetes drugs",
    x = "SIMD",
    y = "Number of Prescriptions",
    color = "Health Board"  # Add legend title for color
  ) +
  scale_x_continuous(limits = c(1, 10), breaks = seq(1, 10, by = 1))

deprivation_lm_model <- lm(paid_quantity ~ simd, data = dp_plot_data)
cor.test(dp_plot_data$paid_quantity, dp_plot_data$simd)
summary(deprivation_lm_model)
```

Graph for prescriptions vs mortality
```{r}
str_mortality_plot_data %>% 
  ggplot(aes(x = mortality, y = paid_quantity, color = hb_name)) +
  geom_point() +
  geom_smooth(method = "lm", color = "red", size = 1) +
  labs(
    title = "Prescriptions of Diabetes Drugs vs Mortality Deaths",
    subtitle = "Relationship between the mortality deaths and the number of prescriptions of diabetes drugs",
    x = "Mortality",
    y = "Number of Prescriptions",
    color = "Health Board"  # Add legend title for color
  )

mortality_lm_model <- lm(paid_quantity ~ mortality, data = str_mortality_plot_data)
cor.test(str_mortality_plot_data$paid_quantity, str_mortality_plot_data$mortality)
summary(mortality_lm_model)
```

GT Table Data
```{r}
  gt_data <- weightdrug_data %>%
  mutate(drug_category = case_when(
    str_detect(bnf_item_description, "METFORMIN") ~ "Metformin",
    str_detect(bnf_item_description, "INSULIN") ~ "Insulin",
    str_detect(bnf_item_description, "OZEMPIC|SAXENDA|TRULICITY|GLUTIDE") ~ "GLP-1 Antagonists",
    str_detect(bnf_item_description, "GLICLAZIDE|GLIPIZIDE") ~ "Sulphonylureas",
    str_detect(bnf_item_description, "GLIFLOZIN") ~ "SGT2 Inhibitors",
    TRUE ~ "Other"
  )) %>%
  group_by(hb_name, drug_category) %>%
  summarise(total_paid_quantity = sum(paid_quantity, na.rm = TRUE)/head(hb_population, 1) * 100000,
            ar_simd = mean(simd2020v2country_decile, na.rm = TRUE),
            mortality_deaths = mean(number_of_deaths, na.rm = TRUE)) %>%
  arrange(hb_name, drug_category)
#Use ifelse or casewhen to get a count of each weight loss drug

  gt_data <- na.omit(gt_data)
#Remember to find a different way to do this
  
gt_data %>%  
  gt() %>% 
     cols_label(
       drug_category = "Drug Category", 
       total_paid_quantity = "Sum of Prescriptions", 
       ar_simd = "Average SIMD",
       mortality_deaths = "Number of Cardiovascular Deaths"
     ) %>% 
     cols_align(
       align = "center",
       columns = everything()
     ) %>% 
  summary_rows(columns = c(total_paid_quantity, ar_simd, mortality_deaths),
               fns = list(Average = ~round(mean(., na.rm = TRUE), 2))) %>% 
  grand_summary_rows(columns = c(total_paid_quantity, ar_simd, mortality_deaths), 
                     fns = list("Overall Average" = ~round(mean(., na.rm = TRUE), 2))) %>% 
     fmt_number(columns = c(total_paid_quantity, ar_simd, mortality_deaths), decimals = 2) %>% 
     tab_header(title = "Prescriptions of Diabetes Drugs and Cardiovascular Mortality Rates and How That Compares Across Socieconomically Diverse Regions",
                subtitle = "Grouped by Health Board") %>% 
     tab_spanner(label = "Rate per 100k",
              columns = c(total_paid_quantity))
```